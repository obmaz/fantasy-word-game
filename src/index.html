<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>킹왕짱 RPG</title>
    <link rel="stylesheet" href="styles/style.css">
</head>

<body>

    <div id="game-screen" style="display:none; height:100%; flex-direction:column;">
        <div class="battle-arena">
            <div class="info-badge" id="wave-badge">Wave: 1</div>
            <div class="info-badge" id="game-info-badge">스토리 모드 - Day 1</div>
            <div class="durability-badge" id="durability-badge">🥊 30/30</div>
            <!-- 배경 위에 골드와 시간 표시 -->
            <div class="overlay-gold">💰 <span id="overlay-gold">0</span> G</div>
            <div class="overlay-timer">
                <div class="timer-bar-bg">
                    <div id="overlay-timer" class="timer-bar-fill"></div>
                </div>
            </div>

            <div class="char-wrapper" id="hero-wrapper">
                <div id="hero-head" class="hero-equip-slot"></div>
                <div id="hero-hand-1" class="hero-equip-slot"></div>
                <div id="hero-hand-2" class="hero-equip-slot"></div>
                <div id="hero-feet" class="hero-equip-slot"></div>
                <img id="hero-img" class="char-img" src="" alt="Hero">
                <div id="hero-weapon" class="equipped-weapon"></div>
                <div id="hero-effect" class="hero-effect" style="display:none;"></div>
            </div>

            <div class="effect-layer">
                <div id="effect-slash"></div>
                <div id="effect-void-bg" class="slash-void-bg"></div>
                <div id="effect-void-core" class="slash-void-core"></div>
            </div>

            <div class="char-wrapper">
                <img id="monster-img" class="char-img" src="" alt="Monster">
            </div>
            <div id="dmg-txt" class="damage-txt"></div>
        </div>

        <div class="quiz-area">
            <div class="question-box">
                <div class="q-label" id="q-label">MEANING</div>
                <div class="q-text" id="q-text">Loading...</div>
            </div>

            <div id="skill-display" class="skill-bar"></div>

            <div id="options-box" class="options-grid"></div>

            <div id="boss-box" class="boss-ui">
                <div style="text-align:center; color:#FF5252; font-weight:bold;" id="boss-title">⚠️ FINAL BOSS</div>
                <div id="boss-hint" class="boss-hint"></div>
                <input type="text" id="boss-input" class="boss-input" placeholder="정답 입력" autocomplete="off">
                <button class="boss-submit" onclick="game.checkBossAnswer()">공격하기</button>
            </div>

        </div>
    </div>

    <div id="start-screen" class="screen-overlay">
        <!-- Title container - constrains buttons within image bounds -->
        <div class="title-container-wrapper">
            <!-- Background image - displayed vertically centered, full height visible -->
            <img src="images/title.webp" alt="Title Screen" class="title-background" />
            
            <!-- Button overlay - matches image size exactly -->
            <div class="title-buttons-overlay">
                <!-- Gold display on title screen -->
                <div class="title-gold-display">💰 <span id="title-ui-gold">0</span> G</div>
                <!-- Interactive button areas (invisible overlays on image buttons) -->
                <!-- STORY MODE = 전투 시작 -->
                <button class="title-btn-area content-visible" id="title-story-mode-btn" title="전투 시작 (STORY MODE)">
                    <img src="images/story_mode.webp" alt="Story Mode" class="btn-image">
                </button>
                <!-- CHAOS RIFT = 혼돈의 균열 -->
                <button class="title-btn-area content-visible" id="title-chaos-rift-btn" title="혼돈의 균열 (CHAOS RIFT)">
                    <img src="images/chaos_rift.webp" alt="Chaos Rift" class="btn-image">
                </button>
                <!-- BOSS RUSH = 무한의 전장 -->
                <button class="title-btn-area content-visible" id="title-boss-rush-btn" title="무한의 전장 (BOSS RUSH)">
                    <img src="images/boss_rush.webp" alt="Boss Rush" class="btn-image">
                </button>
                
                <!-- shop = 상점 -->
                <button class="title-btn-area content-visible" id="title-shop-btn" title="상점 (SHOP)">
                    <img src="images/shop.webp" alt="Shop" class="btn-image">
                </button>
                <!-- profile = 인벤토리 -->
                <button class="title-btn-area content-visible" id="title-profile-btn" title="인벤토리 (PROFILE)">
                    <img src="images/inventory.webp" alt="Inventory" class="btn-image">
                </button>
                <!-- setting = secret 메뉴 (킹 글자 클릭 영역) -->
                <button class="title-btn-area content-visible" id="title-setting-btn" title="시스템 설정 (SETTING)">
                    <img src="images/settings.webp" alt="Settings" class="btn-image">
                </button>
            </div>
        </div>
        
        <!-- Hidden UI elements (kept for functionality but not displayed) -->
        <div style="display: none;">
            <div class="stats-box" id="stat-solved">0</div>
            <div class="stat-item" id="stat-correct">0</div>
            <div class="stat-item" id="stat-rate">0%</div>
            <div id="equipped-summary" class="equipped-summary"></div>
            <select id="day-select"></select>
            <select id="count-select">
                <option value="5">5 마리 (쉬움)</option>
                <option value="10" selected>10 마리 (보통)</option>
                <option value="20">20 마리 (어려움)</option>
            </select>
        </div>
        
        <!-- Hidden buttons for functionality (kept for event listeners) -->
        <button class="btn-main" id="start-battle-btn" style="display: none;">전투 시작 ⚔️</button>
        <button class="btn-main btn-boss-rush" id="boss-rush-btn" style="display: none;">🔥 보스 러시 (무한)</button>
        <button class="btn-main btn-shop" onclick="shop.open()" style="display: none;">상점 🛒</button>
        <button class="btn-main btn-inv" onclick="inventory.open()" style="display: none;">인벤토리 🎒</button>
    </div>

    <div id="inventory-screen" class="screen-overlay" style="display:none;">
        <div class="card">
            <div id="inv-item-detail" style="display:none;">
                <div id="detail-header">
                    <div id="detail-icon"></div>
                    <div id="detail-name"></div>
                    <button id="detail-close" onclick="inventory.hideDetails()">X</button>
                </div>
                <div id="detail-desc"></div>
                <div id="detail-actions"></div>
            </div>

            <div class="inv-header">
                <h2>인벤토리</h2>
                <div style="color:var(--gold);">보유 골드: <span id="inv-gold">0</span> G</div>
            </div>
            <div class="inv-container">
                <div class="inv-player">

                    <!-- Head / hands / torso layout for "사람 모양" 슬롯 -->
                    <div class="inv-head" style="margin-bottom:8px;">
                        <div class="inv-slot" id="inv-head" role="button" tabindex="0" aria-label="머리 슬롯"
                            onclick="inventory.unequip('head')"></div>
                    </div>

                    <div class="inv-body">
                        <div class="inv-slot" id="inv-hand-2" role="button" tabindex="0" aria-label="왼손 슬롯"
                            onclick="inventory.unequip('hand-2')"></div>
                        <div class="inv-torso">
                            <div class="inv-slot" id="inv-weapon" role="button" tabindex="0" aria-label="무기 슬롯"
                                onclick="inventory.unequip('weapon')"></div>
                        </div>
                        <div class="inv-slot" id="inv-hand-1" role="button" tabindex="0" aria-label="오른손 슬롯"
                            onclick="inventory.unequip('hand-1')"></div>
                    </div>

                    <div class="inv-legs">
                        <div class="inv-slot" id="inv-foot-1" role="button" tabindex="0" aria-label="왼발 슬롯"
                            onclick="inventory.unequip('foot-1')"></div>
                        <div class="inv-slot" id="inv-foot-2" role="button" tabindex="0" aria-label="오른발 슬롯"
                            onclick="inventory.unequip('foot-2')"></div>
                    </div>
                </div>
                <div class="inv-storage">
                    <h3>보관함 (장비)</h3>
                    <div class="inv-items">
                    </div>
                    <div class="inv-capacity">용량: <span id="inv-cap">0</span> / <span id="inv-max-cap">3</span></div>

                    <h3 style="margin-top: 20px;">보유 유물</h3>
                    <div class="inv-relics">
                    </div>
                </div>
            </div>
            <button id="inv-close-btn" class="btn-main btn-blue" onclick="inventory.close()"
                aria-label="인벤토리 닫기">나가기</button>
        </div>
    </div>


    <!-- Story Mode Selection Popup -->
    <div id="story-mode-popup" class="screen-overlay" style="display:none;">
        <div class="popup-container-wrapper">
            <img src="images/day_select.webp" alt="Adventure Settings" class="popup-background" id="popup-background-img" />
            <div class="popup-buttons-overlay">
                <!-- 모험 지역 드롭박스 영역 -->
                <select id="popup-day-select" class="popup-select popup-day-select"></select>
                
                <!-- 난이도 드롭박스 영역 -->
                <select id="popup-count-select" class="popup-select popup-count-select">
                    <option value="5">5 마리 (쉬움)</option>
                    <option value="10" selected>10 마리 (보통)</option>
                    <option value="20">20 마리 (어려움)</option>
                </select>
                
                <!-- 시작하기 버튼 영역 -->
                <button class="popup-btn-area" id="popup-start-btn" title="시작하기"></button>
                
                <!-- 취소 버튼 영역 -->
                <button class="popup-btn-area" id="popup-cancel-btn" title="취소"></button>
            </div>
        </div>
        <!-- 기존 텍스트는 숨김 처리 -->
        <div style="display: none;">
            <h2 style="margin-top: 0; color: var(--primary);">모험 설정</h2>
            <div class="adventure-settings">
                <label>모험 지역</label>
                <select id="popup-day-select-hidden"></select>
                <label>난이도 (몬스터 수)</label>
                <select id="popup-count-select-hidden">
                    <option value="5">5 마리 (쉬움)</option>
                    <option value="10" selected>10 마리 (보통)</option>
                    <option value="20">20 마리 (어려움)</option>
                </select>
            </div>
        </div>
    </div>

    <div id="story-screen" class="screen-overlay" style="display:none;">
        <div class="story-container-wrapper">
            <img src="images/start.webp" alt="Adventure Start" class="story-background" id="story-background-img" />
            <div class="story-buttons-overlay">
                <!-- 모험시작 버튼 영역 (이미지의 "모험 시작" 부분) -->
                <button class="story-btn-area" id="story-start-btn" title="모험 시작"></button>
            </div>
        </div>
        <!-- 기존 텍스트는 숨김 처리 -->
        <div style="display: none;">
            <div class="story-title" id="story-title">Title</div>
            <div class="story-text" id="story-text"></div>
            <button class="btn-main" id="story-btn">계속하기</button>
        </div>
    </div>

    <div id="shop-screen" class="screen-overlay" style="display:none;">
        <div class="card">
            <div class="shop-header">
                <h2>상점</h2>
                <div style="color:var(--gold);">보유 골드: <span id="shop-gold">0</span> G</div>
            </div>
            <div class="shop-body">
                <div id="shop-container" style="text-align:left;"></div>
            </div>
            <div class="shop-footer">
                <button class="btn-main btn-blue" onclick="shop.close()">나가기</button>
            </div>
        </div>
    </div>

    <div id="result-screen" class="screen-overlay" style="display:none;">
        <div class="card">
            <h1 id="res-title">Clear!</h1>
            <div style="font-size:50px; margin:10px;">🏆</div>
            <div style="background:#111; padding:15px; border-radius:10px; margin:10px 0;">
                <div style="color:var(--gold); display:flex; justify-content:space-between;"><span>이번 획득:</span>
                    <span>+<span id="res-gain">0</span> G</span></div>
                <div style="color:var(--danger); display:flex; justify-content:space-between;"><span>이번 손실:</span>
                    <span>-<span id="res-lost">0</span> G</span></div>
                <div
                    style="border-top:1px solid #333; margin-top:10px; padding-top:10px; font-weight:bold; font-size:18px; color:var(--primary);">
                    내 지갑 총액: <span id="res-current-total">0</span> G
                </div>
            </div>
            <button class="btn-main" onclick="closeResultScreen()">마을로 귀환</button>
        </div>
    </div>



    <div id="secret-menu-overlay" class="screen-overlay"
        style="display:none; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);">

        <div id="password-modal" class="card">

            <h3>비밀번호 입력</h3>

            <div id="password-input-boxes" style="display: flex; gap: 5px; justify-content: center; margin: 20px 0;">



            </div>

            <p id="password-error" style="color:var(--danger); display:none;">비밀번호가 틀렸습니다.</p>

            <div id="password-numpad"
                style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 200px; margin: 0 auto;">

                <button class="num-btn" onclick="secret.enter(1)">1</button>

                <button class="num-btn" onclick="secret.enter(2)">2</button>

                <button class="num-btn" onclick="secret.enter(3)">3</button>

                <button class="num-btn" onclick="secret.enter(4)">4</button>

                <button class="num-btn" onclick="secret.enter(5)">5</button>

                <button class="num-btn" onclick="secret.enter(6)">6</button>

                <button class="num-btn" onclick="secret.enter(7)">7</button>

                <button class="num-btn" onclick="secret.enter(8)">8</button>

                <button class="num-btn" onclick="secret.enter(9)">9</button>

                <button class="num-btn" onclick="secret.del()">⌫</button>

                <button class="num-btn" onclick="secret.enter(0)">0</button>

                <button class="num-btn" onclick="secret.close()">X</button>

            </div>

        </div>



        <div id="gold-adjuster-modal" class="card" style="display:none;">



            <h3>골드 조정</h3>



            <div class="gold-adjuster">



                <div class="gold-adjust-label">현재 골드</div>



                <div id="current-gold-display" class="gold-display-box">0</div>



                <div class="gold-adjust-label">조정 골드</div>



                <div class="gold-adjust-controls">



                    <button id="gold-down" class="gold-arrow">▼</button>



                    <div id="adjust-gold-display" class="gold-display-box">0</div>



                    <button id="gold-up" class="gold-arrow">▲</button>



                </div>



            </div>



            <button class="btn-main" onclick="secret.applyGold()">적용</button>



            <button class="btn-main btn-blue" onclick="secret.close()">닫기</button>
            <button class="btn-main" style="background: var(--danger); margin-top: 10px;"
                onclick="secret.resetStats()">전체 초기화</button>



        </div>



    </div>



    <!-- Load data files first (wrapped as JavaScript variables to avoid CORS) -->
    <script src="data/game-data.js"></script>
    <script src="data/items-data.js"></script>
    <script src="scripts/words.js"></script>






    <script src="scripts/items.js"></script>



    <script src="scripts/app.js"></script>

    <!-- Background Music -->
    <audio id="background-music" loop>
        <source src="data/background_music.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Background music 초기화 및 재생
        window.addEventListener('load', () => {
            const bgMusic = document.getElementById('background-music');
            if (bgMusic) {
                bgMusic.volume = 0.5; // 볼륨 조절
                bgMusic.play().catch(err => {
                    console.log('Background music autoplay prevented:', err);
                    // 사용자 인터랙션 후 재생 시도
                    document.addEventListener('click', () => {
                        bgMusic.play().catch(() => {});
                    }, { once: true });
                });
            }
        });

        // 백버튼 처리 (게임 중, 상점, 인벤토리에서 시작 화면으로)
        let isGameScreen = false;
        let isShopScreen = false;
        let isInventoryScreen = false;

        // 화면 상태 추적
        const gameScreen = document.getElementById('game-screen');
        const shopScreen = document.getElementById('shop-screen');
        const inventoryScreen = document.getElementById('inventory-screen');
        const startScreen = document.getElementById('start-screen');

        // MutationObserver로 화면 상태 감지
        const observer = new MutationObserver(() => {
            isGameScreen = gameScreen.style.display !== 'none';
            isShopScreen = shopScreen.style.display !== 'none';
            isInventoryScreen = inventoryScreen.style.display !== 'none';
        });

        observer.observe(gameScreen, { attributes: true, attributeFilter: ['style'] });
        observer.observe(shopScreen, { attributes: true, attributeFilter: ['style'] });
        observer.observe(inventoryScreen, { attributes: true, attributeFilter: ['style'] });

        // 백버튼 이벤트 처리 (모바일 브라우저)
        window.addEventListener('popstate', (e) => {
            const storyScreen = document.getElementById('story-screen');
            const storyModePopup = document.getElementById('story-mode-popup');
            const resultScreen = document.getElementById('result-screen');
            
            const isStoryScreen = storyScreen && storyScreen.style.display !== 'none' && storyScreen.style.display !== '';
            const isStoryModePopup = storyModePopup && storyModePopup.style.display !== 'none' && storyModePopup.style.display !== '';
            const isResultScreen = resultScreen && resultScreen.style.display !== 'none' && resultScreen.style.display !== '';
            
            if (isGameScreen || isShopScreen || isInventoryScreen || isStoryScreen || isStoryModePopup || isResultScreen) {
                // 모든 화면 숨기고 시작 화면 표시
                gameScreen.style.display = 'none';
                shopScreen.style.display = 'none';
                inventoryScreen.style.display = 'none';
                
                // 팝업과 스토리 화면도 숨기기
                if (storyScreen) {
                    storyScreen.style.display = 'none';
                    storyScreen.style.visibility = '';
                    storyScreen.style.opacity = '';
                    storyScreen.style.zIndex = '';
                    storyScreen.style.pointerEvents = '';
                    storyScreen.classList.remove('closing');
                }
                if (storyModePopup) {
                    storyModePopup.style.display = 'none';
                    storyModePopup.style.visibility = '';
                    storyModePopup.style.opacity = '';
                    storyModePopup.style.zIndex = '';
                    storyModePopup.style.pointerEvents = '';
                    storyModePopup.classList.remove('closing');
                }
                if (resultScreen) {
                    resultScreen.style.display = 'none';
                    resultScreen.classList.remove('closing');
                }
                
                startScreen.style.display = 'flex';
                
                // 버튼 오버레이 동기화 (이미지 로드 후)
                setTimeout(() => {
                    if (typeof syncTitleButtonOverlay === 'function') {
                        syncTitleButtonOverlay();
                    }
                }, 100);
                
                // 히스토리 조작 방지
                history.pushState(null, '', window.location.href);
            }
        });

        // 초기 히스토리 상태 추가
        history.pushState(null, '', window.location.href);
    </script>

</body>

</html>